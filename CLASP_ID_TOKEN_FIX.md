# Fix for "Invalid Credentials" Error in GAS Deployment

## Problem Summary

The automated Google Apps Script (GAS) deployment was failing with "Invalid Credentials" error during the `clasp push` step.

## Root Cause

The `.clasprc.json` file generated by the deployment scripts was missing the `id_token` field, which is **required** by clasp for OAuth authentication. According to clasp documentation and community issues, the complete token structure must include:

- `access_token` ✓
- `refresh_token` ✓
- `id_token` ❌ (was missing)
- `scope` ✓
- `token_type` ✓
- `expiry_date` ✓

## Solution

Added `CLASP_ID_TOKEN` as a new required environment variable throughout the deployment system:

### Files Modified

1. **scripts/deploy-gas.js**
   - Added `id_token: process.env.CLASP_ID_TOKEN` to the `.clasprc.json` structure
   - Added `CLASP_ID_TOKEN` to the list of required environment variables

2. **.github/workflows/deploy.yml**
   - Added `CLASP_ID_TOKEN: ${{ secrets.CLASP_ID_TOKEN }}` to the deployment job

3. **scripts/setup-clasp.sh**
   - Added `CLASP_ID_TOKEN` to the required variables check
   - Added `"id_token": "$CLASP_ID_TOKEN"` to the `.clasprc.json` template

4. **Documentation Updates**
   - `docs/AI_AGENT_DEPLOYMENT.md` - Added `CLASP_ID_TOKEN` to environment variable examples
   - `scripts/README.md` - Updated environment variable list and examples
   - `docs/OAUTH_SETUP_GUIDE.md` - Added `id_token` to the `.clasprc.json` example and environment variable setup

## How to Obtain the ID Token

The `id_token` is generated when you run `clasp login`. Here's how to extract it:

### Step 1: Login with clasp

```bash
# Install clasp if not already installed
npm install -g @google/clasp

# Login to Google (opens browser)
clasp login
```

### Step 2: Extract the ID Token

```bash
# On Linux/Mac
cat ~/.clasprc.json | grep id_token

# On Windows
type %USERPROFILE%\.clasprc.json | findstr id_token
```

The output will look like:
```json
"id_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjY...[very long string]..."
```

### Step 3: Add to GitHub Secrets

1. Go to your GitHub repository
2. Navigate to **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret**
4. Name: `CLASP_ID_TOKEN`
5. Value: Paste the entire `id_token` value (just the string, without quotes)
6. Click **Add secret**

## Verification

After adding the secret, test the deployment by:

1. Making a commit with `[deploy-gas]` in the commit message
2. Push to the main branch
3. Check the Actions tab to see if the deployment succeeds

Example:
```bash
git commit -m "Test GAS deployment [deploy-gas]"
git push origin main
```

## Technical Details

### Token Format

The complete `.clasprc.json` structure now looks like:

```json
{
  "token": {
    "access_token": "ya29.a0...",
    "refresh_token": "1//0g...",
    "scope": "https://www.googleapis.com/auth/script.projects ...",
    "token_type": "Bearer",
    "id_token": "eyJhbGci...",
    "expiry_date": 1765762095108
  },
  "oauth2ClientSettings": {
    "clientId": "123456789-abc.apps.googleusercontent.com",
    "clientSecret": "GOCSPX-abc123",
    "redirectUri": "http://localhost"
  },
  "isLocalCreds": false
}
```

### Why ID Token is Required

The `id_token` is a JWT (JSON Web Token) that contains identity information about the authenticated user. Clasp uses this token to:

1. Verify the user's identity
2. Maintain session state
3. Refresh access tokens when they expire

Without the `id_token`, clasp cannot properly authenticate with Google's APIs, resulting in the "Invalid Credentials" error.

## Security Considerations

- **Never commit** `.clasprc.json` to version control (it's gitignored)
- **Rotate credentials** periodically for security
- **Use GitHub Secrets** for storing sensitive tokens in CI/CD
- The `id_token` contains encoded user information but is not sensitive on its own - it still requires the other OAuth credentials to be useful

## References

- [Clasp GitHub Issues on Authentication](https://github.com/google/clasp/issues?q=invalid+credentials)
- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Clasp Documentation](https://github.com/google/clasp)

## Troubleshooting

### If deployment still fails after adding ID token:

1. **Check token expiry**: Tokens expire after ~1 week. Run `clasp login` again to generate fresh tokens
2. **Verify all secrets are set**: Ensure all 7 required secrets are configured in GitHub:
   - `CLASP_SCRIPT_ID`
   - `GAS_SHEET_ID`
   - `CLASP_ACCESS_TOKEN`
   - `CLASP_REFRESH_TOKEN`
   - `CLASP_ID_TOKEN`
   - `CLASP_CLIENT_ID`
   - `CLASP_CLIENT_SECRET`
3. **Check OAuth scopes**: Ensure the OAuth credentials have these scopes:
   - `https://www.googleapis.com/auth/script.projects`
   - `https://www.googleapis.com/auth/script.webapp.deploy`
   - `https://www.googleapis.com/auth/drive.file`

---

**Issue Resolved**: This fix addresses the "Invalid Credentials" error during `clasp push` operations.
